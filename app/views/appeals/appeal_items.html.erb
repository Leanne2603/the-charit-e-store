<div class="row">
    <% @appeal.items.each do |item| %>
        <div class="col-md-4">
            <div class="card" style="width: 18rem;">
                <% if item.image.attached? %>
                    <%= cl_image_tag(item.image.key, crop: :scale, width: 400, cloud_name: 'desxzkkeh', class:"card-img-top") %>
                <% end %>
                <div class="card-body">
                    <h5 class="card-title"><%= item.name %></h5>
                    <p class="card-text"><%= item.description %></p>
                    <p class="card-text">Item Price: $<%= "%.2f" % item.price %></p>
                    <% if user_signed_in? && current_user.has_role?(:admin) %>
                    <%= link_to 'Edit Item', edit_item_path(item), class:"btn btn-primary btn-lg" %>
                    <% else %>
                        <button id="buynow-button">Donate Now!</button>
                    <% end %>
                </div>
            </div>
        </div>

        <script>
            const stripe = Stripe('<%= ENV["STRIPE_PUBLISHABLE_KEY"] %>')
            const buyButton = document.getElementById('buynow-button')

            buyButton.addEventListener('click', function() {
                fetch('<%= buy_path(item.id) %>', {
                    method: 'POST'
                })
                .then(function(response) {
                    return response.json()
                })
                .then(function(session) {
                    return stripe.redirectToCheckout({ sessionId: session.id})
                })
            })
        </script>
    <% end %>
</div>